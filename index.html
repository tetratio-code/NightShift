<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>排班最佳化</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Arial, "Noto Sans TC", sans-serif; margin: 16px; line-height: 1.4; }
    h1 { margin: 0 0 12px; font-size: 22px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; max-width: 1200px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; }
    .row { display: grid; grid-template-columns: 200px 1fr; gap: 10px; align-items: center; margin: 8px 0; }
    input[type="number"], textarea, select { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
    textarea { min-height: 70px; resize: vertical; }
    .two { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .btns { display: flex; gap: 10px; flex-wrap: wrap; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #333; background: #111; color: #fff; cursor: pointer; }
    button.secondary { background: #fff; color: #111; border-color: #777; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .hint { color: #555; font-size: 13px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .ok { color: #0a7; }
    .warn { color: #b60; }
    .err { color: #c00; }
    .small { font-size: 12px; }
    .ptGrid { display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 8px; }
    .ptRow { display: grid; grid-template-columns: 210px 120px 1fr; gap: 10px; align-items: center; }
    .pill { display: inline-block; padding: 2px 8px; border: 1px solid #ddd; border-radius: 999px; font-size: 12px; background: #fafafa; }
  </style>
</head>
<body>
  <h1>排班最佳化</h1>

  <div class="grid">
    <div class="card">
      <div class="row">
        <div>當月天數</div>
        <input id="days" type="number" min="1" max="31" value="31" />
      </div>

      <div class="row">
        <div>起始星期</div>
        <select id="start">
          <option value="1">1（一）</option>
          <option value="2">2（二）</option>
          <option value="3">3（三）</option>
          <option value="4">4（四）</option>
          <option value="5" selected>5（五）</option>
          <option value="6">6（六）</option>
          <option value="7">7（日）</option>
        </select>
      </div>

      <div class="row">
        <div>需要排班的天數（自動）</div>
        <div>
          <span class="pill">grid days = <b id="gridDays">-</b></span>
          <span class="pill">星期日天數 = <b id="sunCount">-</b></span>
        </div>
      </div>

      <div class="row">
        <div>免排班日期（shift=3）</div>
        <textarea id="skipDates" class="mono" placeholder="例如：17,-24 &#10;正數：星期日預設白班；負數：星期日夜班"></textarea>
      </div>
    </div>

    <div class="two">
      <div class="card">
        <h3 style="margin:0 0 8px;">人員 1</h3>

        <div class="row">
          <div>預排班數</div>
          <input id="count1" type="number" min="0" value="17" />
        </div>

        <div class="row">
          <div>上月底情形</div>
          <input id="prev1" type="number" value="4" />
        </div>

        <div class="row">
          <div>預不值班日期</div>
          <textarea id="no1" class="mono" placeholder="例如：7,8,25 或 0 代表無"></textarea>
        </div>

        <div class="row">
          <div>偏好設定（越高越不想）</div>
          <div>
            <div class="small">目前權重：<span class="mono" id="ptPreview1"></span></div>
          </div>
        </div>

        <div id="ptUI1" class="ptGrid"></div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px;">人員 2</h3>

        <div class="row">
          <div>預排班數</div>
          <input id="count2" type="number" min="0" value="17" />
        </div>

        <div class="row">
          <div>上月底情形</div>
          <input id="prev2" type="number" value="-4" />
        </div>

        <div class="row">
          <div>預不值班日期</div>
          <textarea id="no2" class="mono" placeholder="例如：7,8,25 或 0 代表無"></textarea>
        </div>

        <div class="row">
          <div>偏好設定（越高越不想）</div>
          <div>
            <div class="hint">pt = 2^選單數字（自動換算）</div>
            <div class="small">目前權重：<span class="mono" id="ptPreview2"></span></div>
          </div>
        </div>

        <div id="ptUI2" class="ptGrid"></div>
      </div>
    </div>

    <div class="card">
      <div class="btns">
        <button id="runBtn">開始排班（找最低分）</button>
        <button id="stopBtn" class="secondary" disabled>停止</button>
        <button id="loadDemoBtn" class="secondary">載入 input.txt 範例1</button>
        <button id="clearBtn" class="secondary">清空輸出</button>
      </div>
      <div id="status" class="hint" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;">輸出</h3>
      <div id="output"></div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const runBtn = $("runBtn");
  const stopBtn = $("stopBtn");
  const loadDemoBtn = $("loadDemoBtn");
  const clearBtn = $("clearBtn");
  const statusEl = $("status");
  const outputEl = $("output");

  // 12 個偏好項目標籤（對應你說明）
  const PT_LABELS = [
    "上1天", "上2天", "上3天", "上4天", "上5天", "上6天",
    "上7天", "上星期日白班", "休1天", "休2天", "休1.5天", "上>7天"
  ];

  // ===== Helpers =====
  function parseIntList(text) {
    if (!text || !text.trim()) return [];
    return text
      .replace(/\n/g, ",")
      .split(/[, ]+/)
      .map(s => s.trim())
      .filter(s => s.length && s !== "0")
      .map(s => {
        const v = Number(s);
        if (!Number.isFinite(v) || !Number.isInteger(v)) throw new Error(`不是整數：${s}`);
        return v;
      });
  }

  function pow2(n) { return 1 << n; } // 2^n，n=0..10 安全
  function formatPt(arr) { return arr.map(v => String(v)).join(","); }

  // ===== Auto grid days = monthDays + sundayCount =====
  function countSundaysInMonth(monthDays, start) {
    let c = 0;
    for (let d = 1; d <= monthDays; d++) {
      const wd = ((start - 1 + (d - 1)) % 7) + 1; // 1..7
      if (wd === 7) c++;
    }
    return c;
  }

  function getGridDays(monthDays, start) {
    const sun = countSundaysInMonth(monthDays, start);
    return { gridDays: monthDays + sun, sunCount: sun };
  }

  function updateGridDaysUI() {
    const monthDays = Number($("days").value);
    const start = Number($("start").value);
    if (!Number.isInteger(monthDays) || monthDays <= 0) return;
    if (!Number.isInteger(start) || start < 1 || start > 7) return;

    const { gridDays, sunCount } = getGridDays(monthDays, start);
    $("sunCount").textContent = String(sunCount);
    $("gridDays").textContent = String(gridDays);
  }

  // ===== PT UI (0-10 select => pt = 2^k) =====
  function buildPtUI(containerId, previewId, defaultLevels) {
    const wrap = $(containerId);
    wrap.innerHTML = "";

    for (let i = 0; i < 12; i++) {
      const row = document.createElement("div");
      row.className = "ptRow";

      const label = document.createElement("div");
      label.textContent = `${i+1}. ${PT_LABELS[i]}`;

      const sel = document.createElement("select");
      sel.dataset.ptIndex = String(i);
      for (let k = 0; k <= 10; k++) {
        const opt = document.createElement("option");
        opt.value = String(k);
        opt.textContent = String(k);
        sel.appendChild(opt);
      }
      sel.value = String(defaultLevels?.[i] ?? 0);

      const computed = document.createElement("div");
      computed.className = "hint mono";
      computed.textContent = `pt=${pow2(Number(sel.value))}`;

      sel.addEventListener("change", () => {
        computed.textContent = `pt=${pow2(Number(sel.value))}`;
        updatePtPreview();
      });

      row.appendChild(label);
      row.appendChild(sel);
      row.appendChild(computed);
      wrap.appendChild(row);
    }

    function getPtArray() {
      const selects = wrap.querySelectorAll("select");
      const pt = [];
      selects.forEach(s => pt.push(pow2(Number(s.value))));
      return pt;
    }

    function updatePtPreview() {
      $(previewId).textContent = formatPt(getPtArray());
    }

    updatePtPreview();
    return { getPtArray, updatePtPreview };
  }

  const pt1UI = buildPtUI("ptUI1", "ptPreview1", [2,1,0,0,2,5,6,0,5,1,3,10]);
  const pt2UI = buildPtUI("ptUI2", "ptPreview2", [2,1,0,0,2,5,6,0,5,1,3,10]);

  // ====== 新增：班數總和檢查 + 禁用排班 ======
  function mapDateToIndex(k, start) {
    // 沿用你原 C 的映射方式（正數/負數）
    if (k < 0) {
      const d = -k;
      return d + Math.floor((d + start - 2) / 7) + 1;
    } else {
      return k + Math.floor((k + start - 2) / 7);
    }
  }

  function getUniqueValidSkipCount(skipDates, start, gridDays) {
    // 將 skipDates 映射到 grid index，過濾 1..gridDays，並去重
    const s = new Set();
    for (const d of skipDates) {
      const idx = mapDateToIndex(d, start);
      if (idx >= 1 && idx <= gridDays) s.add(idx);
    }
    return s.size;
  }

  function ensureWarnBox() {
    // 在按鈕區塊下方塞一個警告 div（只建立一次）
    let warn = $("warnBox");
    if (warn) return warn;

    warn = document.createElement("div");
    warn.id = "warnBox";
    warn.style.marginTop = "8px";
    warn.className = "hint";
    // 插在 statusEl 前面（也就是按鈕下方、status 上方/同區）
    statusEl.parentNode.insertBefore(warn, statusEl);
    return warn;
  }

  function validateTotalsAndToggleRun() {
    const warnBox = ensureWarnBox();

    // 基本輸入合法性先檢查，避免 NaN
    const monthDays = Number($("days").value);
    const start = Number($("start").value);
    const c1 = Number($("count1").value);
    const c2 = Number($("count2").value);

    if (!Number.isInteger(monthDays) || monthDays <= 0 ||
        !Number.isInteger(start) || start < 1 || start > 7 ||
        !Number.isInteger(c1) || c1 < 0 ||
        !Number.isInteger(c2) || c2 < 0) {
      runBtn.disabled = true;
      warnBox.innerHTML = `<span class="err">⚠️ 輸入格式不正確（天數/星期/班數需為整數且不可為負）</span>`;
      return false;
    }

    const { gridDays } = getGridDays(monthDays, start);

    let skipDates = [];
    try {
      skipDates = parseIntList($("skipDates").value);
    } catch (e) {
      runBtn.disabled = true;
      warnBox.innerHTML = `<span class="err">⚠️ 免排班日期格式錯誤：</span>${e.message}`;
      return false;
    }

    const skipCount = getUniqueValidSkipCount(skipDates, start, gridDays);
    const requiredWorkDays = gridDays - skipCount;
    const assigned = c1 + c2;

    if (assigned !== requiredWorkDays) {
      runBtn.disabled = true;
      warnBox.innerHTML =
        `<span class="err">⚠️ 班數總和不正確：</span>` +
        `需要排班 <b>${gridDays}</b> 天（含星期日），免排 <b>${skipCount}</b> 天 → ` +
        `實際需排 <b>${requiredWorkDays}</b> 天；` +
        `但人員1+人員2 = <b>${assigned}</b>（${c1}+${c2}）。` +
        `<div class="small">請調整「免排班日期」或兩位人員「預排班數」，使兩者相等。</div>`;
      return false;
    }

    // OK
    warnBox.innerHTML = `<span class="ok">✓ 班數總和正確：</span>實際需排 <b>${requiredWorkDays}</b> 天，已分配 <b>${assigned}</b> 天。`;
    runBtn.disabled = false;
    return true;
  }

  // ===== Scheduler Core =====
  let stopFlag = false;

  function solve(params) {
    let { monthDays, start, skipDates, people } = params;

    const sundayCount = countSundaysInMonth(monthDays, start);
    const days = monthDays + sundayCount;

    const shift = new Array(days + 2).fill(0);
    const no = Array.from({ length: 3 }, () => new Array(days + 2).fill(0));
    const seq = Array.from({ length: 3 }, () => new Array(days + 6).fill(0));
    const pt = Array.from({ length: 3 }, () => new Array(13).fill(0));

    const count = [0, people[1].count, people[2].count];
    const prev = [0, people[1].prev, people[2].prev];

    function mapDateToIndexLocal(k) {
      return mapDateToIndex(k, start);
    }

    for (const d of skipDates) {
      const idx = mapDateToIndexLocal(d);
      if (idx >= 1 && idx <= days) shift[idx] = 3;
    }

    for (let p = 1; p <= 2; p++) {
      const pts = people[p].pt;
      if (pts.length !== 12) throw new Error(`人員${p} 的 pt 需要 12 個數字`);
      for (let i = 1; i <= 12; i++) pt[p][i] = pts[i - 1];

      for (const d of people[p].noDates) {
        const idx = mapDateToIndexLocal(d);
        if (idx >= 1 && idx <= days) no[p][idx] = 1;
      }
    }

    for (let i = 0; i <= days; i++) shift[i] = shift[i] - (shift[i] % 3);

    let max = 1000;
    let today = 1;
    let back = 0;
    const sum = [0, 0, 0];

    function calc() {
      for (let k = 0; k <= 2; k++) {
        let n = 0;
        for (let i = 0; i <= days; i++) seq[k][i] = 0;
        seq[k][0] = prev[k];

        for (let i = 1; i <= days; i++) {
          if (((start + i - 1) % 8) === 7) {
            if (shift[i] === k) {
              if (seq[k][n] > -50) seq[k][n] -= 50;
              n++;
              seq[k][n] = 50; n++;
              seq[k][n] -= 50;
            }
          } else if (shift[i] === k) {
            if (seq[k][n] < 0) n++;
            seq[k][n] += 1;
          } else if (shift[i] !== k) {
            if (seq[k][n] > 0) n++;
            seq[k][n] -= 1;
          }
        }
      }

      let score = 0;
      for (let k = 1; k <= 2; k++) {
        for (let i = 0; i <= days; i++) {
          if (today <= days && seq[k][i + 2] === 0) break;
          if (seq[k][i] < 0 && seq[k][i + 1] === 0) break;

          const v = seq[k][i];
          if (v === 1) score += pt[k][1];
          else if (v === 2) score += pt[k][2];
          else if (v === 3) score += pt[k][3];
          else if (v === 4) score += pt[k][4];
          else if (v === 5) score += pt[k][5];
          else if (v === 6) score += pt[k][6];
          else if (v === 7) score += pt[k][7];
          else if (v === 50) score += pt[k][8];
          else if (v === -1) score += pt[k][9];
          else if (v === -51) score += pt[k][10];
          else if (v === -2) score += pt[k][11];
          else if (v > 7) score += pt[k][12];
        }
      }

      let kBal = 0;
      if (today > days) {
        for (let i = 8 - start; i <= days; i += 8) {
          if (shift[i] === 1) kBal++;
          if (shift[i] === 2) kBal--;
        }
        if ((kBal * kBal) > 2) score += 256;
      }
      return score;
    }

    function renderBest(bestScore) {
      const header = ["一","二","三","四","五","六","日","夜"];
      let html = `<div class="mono"><div>-----------------------</div>`;
      html += `<div>${header.join(" ")}</div>`;

      let line = "";
      for (let k = 1; k < start; k++) line += "   ";

      for (let k = 1; k <= days; k++) {
        const v = shift[k];
        line += String(v).padStart(2," ") + " ";
        if (((k + start - 1) % 8) === 0 && k < days) {
          html += `<div>${line.replace(/ /g,"&nbsp;")}</div>`;
          line = "";
        }
      }
      if (line.trim().length) html += `<div>${line.replace(/ /g,"&nbsp;")}</div>`;

      html += `<div>score=${bestScore}</div>`;

      for (let k = 1; k <= 2; k++) {
        html += `<br/><div>人員${k}:</div>`;
        html += `<div class="small">`;
      
        if (prev[k] > 0 && shift[1] === k)
          html += `含上個月連 `;
        else if (prev[k] < 0 && shift[1] !== k)
          html += `含上個月連 `;
        else if (prev[k] !== 0)
          html += `上個月 `;
      
        for (let i = 0; i < days; i++) {
          const v = seq[k][i];
          if (v === 50) html += `星期天白班, `;
          else if (v < -50) html += `休${(-50 - v)}.5天, `;
          else if (v < 0) html += `休${(-v)}天, `;
          else if (v > 0) html += `上${v}天, `;
        }
      
        html += `</div>`;
      }

      html += `</div>`;
      return html;
    }

    let bestFound = false;

    while (true) {
      if (stopFlag) break;

      while (today <= days && today > 0) {
        if (stopFlag) break;

        if (shift[today] === 3 && back === 1) { today--; continue; }
        back = 0;

        if (shift[today] === 0) { shift[today] = 1; sum[1]++; }
        else if (shift[today] === 1) { shift[today] = 2; sum[1]--; sum[2]++; }
        else if (shift[today] === 2) { shift[today] = 0; today--; back = 1; sum[2]--; }

        if (shift[today] === 3 && back === 0) { today++; continue; }
        if (shift[today] === 3 && back === 1) { today--; continue; }
        if (back === 1) continue;

        if (no[shift[today]][today] === 1) continue;
        if (sum[1] > count[1]) continue;
        if (sum[2] > count[2]) continue;

        if (((start + today - 1) % 8) === 7 && shift[today] === shift[today - 1]) continue;
        if (((start + today - 1) % 8) === 0 && shift[today] === shift[today - 1]) continue;

        if (calc() >= max) continue;
        today++;
      }

      if (stopFlag) break;
      if (today < 1) break;

      const t = calc();
      if (t < max) {
        max = t;
        bestFound = true;
        outputEl.innerHTML = renderBest(t);
        setStatus(`<span class="ok">找到更佳解</span> best score = <b>${t}</b>（grid days=${days}）`, "hint");
      }

      today = days;
      back = 1;
    }

    return { bestFound, bestScore: max, gridDays: days };
  }

  function setStatus(msg, cls="hint") {
    statusEl.className = cls;
    statusEl.innerHTML = msg;
  }

  function getParamsFromUI() {
    const monthDays = Number($("days").value);
    const start = Number($("start").value);
    if (!Number.isInteger(monthDays) || monthDays <= 0) throw new Error("當月天數需為正整數");
    if (!Number.isInteger(start) || start < 1 || start > 7) throw new Error("start 需在 1..7");

    const skipDates = parseIntList($("skipDates").value);

    const p1 = {
      count: Number($("count1").value),
      prev: Number($("prev1").value),
      pt: pt1UI.getPtArray(),
      noDates: parseIntList($("no1").value),
    };
    const p2 = {
      count: Number($("count2").value),
      prev: Number($("prev2").value),
      pt: pt2UI.getPtArray(),
      noDates: parseIntList($("no2").value),
    };

    if (!Number.isInteger(p1.count) || p1.count < 0) throw new Error("人員1 班數需為非負整數");
    if (!Number.isInteger(p2.count) || p2.count < 0) throw new Error("人員2 班數需為非負整數");
    if (!Number.isInteger(p1.prev)) throw new Error("人員1 prev 需為整數");
    if (!Number.isInteger(p2.prev)) throw new Error("人員2 prev 需為整數");

    return { monthDays, start, skipDates, people: {1:p1, 2:p2} };
  }

  async function run() {
    // 新增：開始前再驗證一次（避免用 JS 繞過 disabled）
    if (!validateTotalsAndToggleRun()) return;

    stopFlag = false;
    runBtn.disabled = true;
    stopBtn.disabled = false;

    outputEl.innerHTML = "";
    setStatus("運算中…（如果條件很緊或天數較大，可能需要較久）", "hint");

    let params;
    try {
      params = getParamsFromUI();
    } catch (e) {
      setStatus(`<span class="err">輸入錯誤：</span>${e.message}`, "err");
      runBtn.disabled = false;
      stopBtn.disabled = true;
      return;
    }

    await new Promise(r => setTimeout(r, 0));

    try {
      const res = solve(params);
      if (stopFlag) {
        setStatus(`<span class="warn">已停止。</span>（可能已找到部分解）`, "warn");
      } else if (!res.bestFound) {
        setStatus(`<span class="err">找不到可行解。</span>（請檢查班數/禁排/免排是否過度限制）`, "err");
      } else {
        setStatus(`<span class="ok">完成。</span> best score = <b>${res.bestScore}</b>（grid days=${res.gridDays}）`, "ok");
      }
    } catch (e) {
      setStatus(`<span class="err">執行失敗：</span>${e.message}`, "err");
    } finally {
      // 結束後恢復按鈕狀態，但仍要以驗證結果決定能否再次開始
      stopBtn.disabled = true;
      validateTotalsAndToggleRun();
    }
  }

  function stop() {
    stopFlag = true;
    setStatus(`<span class="warn">收到停止指令…</span>（會在下一個迴圈檢查點停下）`, "warn");
  }

  function clearOutput() {
    outputEl.innerHTML = "";
    setStatus("", "hint");
  }

  function loadDemo() {
    $("days").value = 31;
    $("start").value = 5;
    $("skipDates").value = "17,-24";

    $("count1").value = 17;
    $("prev1").value = 4;
    $("no1").value = "7,8,25";

    $("count2").value = 17;
    $("prev2").value = -4;
    $("no2").value = "0";

    updateGridDaysUI();
    validateTotalsAndToggleRun();
    setStatus("已載入範例1", "hint");
  }

  // ===== events =====
  $("days").addEventListener("input", () => { updateGridDaysUI(); validateTotalsAndToggleRun(); });
  $("start").addEventListener("change", () => { updateGridDaysUI(); validateTotalsAndToggleRun(); });

  $("skipDates").addEventListener("input", validateTotalsAndToggleRun);
  $("count1").addEventListener("input", validateTotalsAndToggleRun);
  $("count2").addEventListener("input", validateTotalsAndToggleRun);

  runBtn.addEventListener("click", run);
  stopBtn.addEventListener("click", stop);
  loadDemoBtn.addEventListener("click", loadDemo);
  clearBtn.addEventListener("click", clearOutput);

  // init
  updateGridDaysUI();
  loadDemo();
})();
</script>
